<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Presales KI - Angebotsunterstützung</title>
  <style>
    :root{
      --bg0:#0b1020;
      --bg1:#0f172a;
      --card: rgba(255,255,255,.05);
      --card2: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.10);
      --text:#e5e7eb;
      --muted:#a7b0c0;
      --primary:#7c3aed;
      --primary2:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --surface-panel: rgba(9,14,28,.9);
      --surface-panel-hover: rgba(255,255,255,.03);
      --surface-panel-border: rgba(255,255,255,.08);
      --surface-panel-border-strong: rgba(255,255,255,.14);
      --input-bg: rgba(255,255,255,.03);
      --input-bg-focus: rgba(255,255,255,.05);
      --input-border: rgba(255,255,255,.12);
      --input-border-focus: rgba(124,58,237,.5);
      --select-bg: #111522;
      --select-border: rgba(255,255,255,.06);
      --select-hover: rgba(255,255,255,.06);
      --select-active: rgba(120,90,255,.25);
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius: 18px;
      --radius-sm: 12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 8% 10%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(900px 500px at 90% 20%, rgba(34,197,94,.22), transparent 55%),
        radial-gradient(900px 700px at 40% 110%, rgba(59,130,246,.18), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    a{color:inherit}
    .page{max-width:1200px;margin:0 auto;padding:26px 18px 42px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      margin-bottom:18px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;align-items:center;gap:12px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(34,197,94,.8));
      box-shadow: 0 16px 40px rgba(124,58,237,.25);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute;inset:10px;
      border-radius:12px;
      background: rgba(15,23,42,.35);
      border:1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(8px);
    }
    h1{margin:0;font-size:22px;letter-spacing:.2px}
    .subtitle{margin:2px 0 0;color:var(--muted);font-size:13px}
    .pillbar{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid transparent;
      background: rgba(255,255,255,.03);
      display:flex;align-items:center;gap:8px;
      box-shadow:none;
    }
    .pill-run{min-width:220px;gap:10px;}
    .pill-run .run-meta{display:flex;flex-direction:column;gap:6px;flex:1;min-width:0}
    .pill-run .run-line{display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:12px}
    .pill-run .run-line .muted{color:var(--muted);}
    .pill-run .run-progress{
      width:120px;
      height:8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      overflow:hidden;
    }
    .pill-run .run-progress div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(124,58,237,.95), rgba(34,197,94,.7));
      transition: width .2s ease;
    }
    @media (max-width: 520px){
      .pill-run{min-width:180px;}
      .pill-run .run-line .kbd{font-size:11px;padding:1px 6px;}
      .pill-run .run-progress{height:6px;width:100px;}
    }
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.35)}
    .dot.ok{background:rgba(34,197,94,.9)}
    .dot.warn{background:rgba(245,158,11,.9)}
    .dot.bad{background:rgba(239,68,68,.9)}

    .layout{
      display:grid;
      grid-template-columns: 1.08fr .92fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      .pillbar{justify-content:flex-start}
    }

    .card{
      background: linear-gradient(180deg, var(--card), rgba(255,255,255,.02));
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow:hidden;
    }
    .card-h{
      padding:16px 16px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .card-h h2{margin:0;font-size:16px}
    .card-h p{margin:4px 0 0;color:var(--muted);font-size:12.5px;line-height:1.35}
    .card-b{padding:16px}

    label{
      display:flex;align-items:center;gap:8px;
      font-size:12.5px;color:var(--muted);
      margin:0 0 6px;
    }
    .tip-icon{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:18px;height:18px;
      border-radius:999px;
      border:1px solid var(--surface-panel-border);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.85);
      font-size:12px;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease, color .15s ease;
      flex:0 0 auto;
    }
    .tip-icon:hover, .tip-icon:focus{
      outline:none;
      background: rgba(255,255,255,.08);
      border-color: var(--surface-panel-border-strong);
      color: #fff;
    }

    input[type="text"], input[type="number"], input[type="email"], select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius: 14px;
      border:1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 14px;
      appearance: none;
      -webkit-appearance: none;
      outline:none;
      transition: transform .08s ease, border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    textarea{min-height: 112px; resize: vertical}
    input:focus, select:focus, textarea:focus{
      border-color: var(--input-border-focus);
      box-shadow: 0 0 0 3px rgba(124,58,237,.16);
      background: var(--input-bg-focus);
    }

    /* Custom select */
    .select{
      position:relative;
    }
    .select-button{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:11px 12px;
      border-radius:14px;
      background: var(--select-bg);
      border:1px solid transparent;
      color: var(--text);
      cursor:pointer;
      font-size:14px;
      transition: border-color .12s ease, background .12s ease, box-shadow .12s ease;
    }
    .select-button:hover{
      background: var(--select-hover);
      border-color: var(--select-border);
    }
    .select-button:focus{
      outline:none;
      border-color: var(--input-border-focus);
      box-shadow: 0 0 0 2px rgba(124,58,237,.12);
    }
    .select-caret{
      font-size:12px;
      color: var(--muted);
    }
    .select-popover{
      position:absolute;
      z-index:900;
      top:calc(100% + 6px);
      left:0;
      right:0;
      background: #151821;
      border:1px solid var(--select-border);
      border-radius:12px;
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      padding:6px;
      display:none;
    }
    .select-popover.open{display:block;}
    .select-options{
      list-style:none;
      margin:0;
      padding:0;
      max-height:220px;
      overflow:auto;
    }
    .select-option{
      padding:10px 10px;
      border-radius:10px;
      color: var(--text);
      cursor:pointer;
      transition: background .12s ease, color .12s ease;
    }
    .select-option:hover,
    .select-option[aria-selected="true"]{
      background: var(--select-hover);
    }
    .select-option.active{
      background: var(--select-active);
      border:1px solid rgba(124,58,237,.18);
    }

    .grid2{display:grid;grid-template-columns: 1fr 1fr;gap:12px}
    @media (max-width: 720px){ .grid2{grid-template-columns:1fr} }
    .stack-vertical{display:flex;flex-direction:column;gap:12px;height:100%}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .field{margin-bottom:12px}
    .field.error input,
    .field.error textarea{
      border-color: var(--bad);
      box-shadow: 0 0 0 2px rgba(239,68,68,.18);
    }
    .error-text{
      color: var(--bad);
      font-size: 12px;
      margin-top: 6px;
      display:none;
    }
    .error-text.show{display:block}
    .field-error{
      display:none;
      margin-top:6px;
      color: rgba(239,68,68,.95);
    }
    input.invalid{
      border-color: rgba(239,68,68,.7);
      box-shadow: 0 0 0 3px rgba(239,68,68,.12);
    }

    .btnbar{display:flex;gap:10px;align-items:center;margin-top:6px;flex-wrap:wrap}
    .btn{
      border:none;
      border-radius: 14px;
      padding: 12px 14px;
      cursor:pointer;
      font-weight: 700;
      font-size: 13.5px;
      letter-spacing: .2px;
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      transition: transform .08s ease, box-shadow .15s ease, background .15s ease, opacity .15s ease;
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn-primary{
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(124,58,237,.55));
      color:white;
      box-shadow: 0 16px 40px rgba(124,58,237,.22);
      flex: 1 1 auto;
    }
    .btn-primary:hover{background: linear-gradient(135deg, rgba(124,58,237,1), rgba(34,197,94,.55))}
    .btn-ghost{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
    }
    .btn-ghost:hover{background: rgba(255,255,255,.06)}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .spinner{
      width:16px;height:16px;border-radius:999px;
      border:2px solid rgba(255,255,255,.28);
      border-top-color: rgba(255,255,255,.9);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .tabs{display:flex;gap:8px;margin: 0 0 10px}
    .tab-btn{
      flex:1;
      padding: 10px 11px;
      border-radius: 14px;
      border:1px solid transparent;
      background: rgba(255,255,255,.02);
      color: rgba(255,255,255,.82);
      cursor:pointer;
      font-weight: 700;
      transition: background .15s ease, border-color .15s ease, color .15s ease;
    }
    .tab-btn.active{
      background: linear-gradient(180deg, rgba(124,58,237,.14), rgba(124,58,237,.04));
      border-color: rgba(124,58,237,.18);
      color: rgba(255,255,255,.94);
    }
    .tab-btn:hover{
      background: rgba(255,255,255,.04);
      border-color: var(--surface-panel-border-strong);
    }
    .panel{
      border-radius: var(--radius);
      border:1px solid var(--surface-panel-border);
      background: var(--surface-panel);
      padding:14px;
      min-height: 170px;
      font-size: 13.5px;
      line-height: 1.55;
      white-space: pre-wrap;
      overflow-wrap:anywhere;
    }
    .panel.mono{font-family: var(--mono); font-size: 12.8px; overflow-x:auto; overflow-wrap:anywhere;}
    .panel.hidden{display:none}
    .panel:hover{
      background: linear-gradient(180deg, var(--surface-panel), var(--surface-panel-hover));
      border-color: var(--surface-panel-border-strong);
    }
    .refs-wrap{
      margin-top:12px;
      border:1px solid var(--surface-panel-border);
      background: var(--surface-panel);
      border-radius: var(--radius);
      padding:12px;
    }
    .refs-title{
      font-weight:800;
      margin:0 0 10px;
      letter-spacing:.2px;
    }
    .refs-list{display:flex;flex-direction:column;gap:10px}
    .refs-item{
      border:1px solid var(--surface-panel-border);
      border-left:3px solid var(--primary);
      border-radius:12px;
      padding:10px 12px;
      background: rgba(255,255,255,.02);
      transition: border-color .12s ease, background .12s ease;
    }
    .refs-item:hover{
      border-color: var(--surface-panel-border-strong);
      background: var(--surface-panel-hover);
    }
    .refs-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:6px;
    }
    .refs-id{font-weight:800;}
    .refs-tags{display:flex;gap:8px;flex-wrap:wrap}
    .refs-reason{color:var(--muted);font-size:12.5px;line-height:1.45}
    .tag.tag-ghost{
      background: rgba(255,255,255,.05);
      border-color: rgba(255,255,255,.18);
      color: rgba(255,255,255,.85);
    }
    .tooltip-bubble{
      position:absolute;
      z-index:1000;
      max-width:320px;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--surface-panel-border-strong);
      background: rgba(8,12,24,.96);
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      color: var(--text);
      font-size:12.8px;
      line-height:1.5;
      pointer-events:none;
      opacity:0;
      transform: translateY(-4px);
      transition: opacity .12s ease, transform .12s ease;
    }
    .tooltip-bubble.show{
      opacity:1;
      transform: translateY(0);
    }
    .tooltip-bubble ul{padding-left:16px;margin:6px 0 0;}
    .tooltip-bubble li{margin:2px 0;}

    /* Details/accordion fallback if used */
    details{
      background: var(--surface-panel);
      border:1px solid var(--surface-panel-border);
      border-radius: var(--radius-sm);
      padding:10px 12px;
      transition: border-color .15s ease, background .15s ease;
    }
    details[open]{border-color: var(--surface-panel-border-strong); background: linear-gradient(180deg, 
var(--surface-panel), var(--surface-panel-hover));}
    details summary{cursor:pointer; color: var(--text); font-weight: 700; outline:none;}
    details summary:hover{color: #fff;}

    .eval{
      margin-top:12px;
      border-radius: var(--radius);
      border:1px dashed rgba(255,255,255,.22);
      background: rgba(255,255,255,.02);
      padding:12px;
    }
    .radio-row{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:10px;font-size:13px}
    .radio-row label{margin:0;color:rgba(255,255,255,.9);font-size:13px}
    .radio-row input{accent-color: var(--primary)}
    .notice{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(34,197,94,.35);
      background: rgba(34,197,94,.10);
      color: rgba(240,253,244,.95);
      display:none;
      font-weight: 700;
      font-size: 13px;
    }
    .notice.show{display:block}

    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
    th{color:rgba(255,255,255,.65);font-weight:800;font-size:12px;letter-spacing:.2px}
    tr:hover td{background: rgba(255,255,255,.03)}
    .tag{
      display:inline-flex;gap:8px;align-items:center;
      padding:4px 10px;border-radius:999px;
      background: rgba(124,58,237,.16);
      border:1px solid rgba(124,58,237,.25);
      font-weight:800;font-size:12px;
    }
    .rating{font-size: 16px}
    .small{color:var(--muted);font-size:12px}
    .foot{
      margin-top:12px;
      color: rgba(255,255,255,.55);
      font-size: 12px;
      line-height: 1.45;
    }
    .kbd{
      font-family: var(--mono);
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.85);
    }

    @media (max-width: 720px){
      .page{padding:18px 12px 28px}
      header{flex-wrap:wrap}
      .card-h{flex-wrap:wrap}
      .btnbar{flex-wrap:wrap}
      .btn{flex:1 1 180px}
      .grid2{grid-template-columns:1fr}
      .pillbar{justify-content:flex-start}
    }
    @media (max-width: 420px){
      h1{font-size:18px}
      .btn{flex-basis:100%}
    }
  </style>
</head>

<body>
  <div id="buildStamp" style="position:fixed;bottom:10px;right:10px;z-index:9999;font:12px monospace;opacity:.7">
    BUILD: 2025-01-11T00:00:00Z
  </div>
  <div class="page">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Presales KI - Angebotsunterstützung</h1>
          <div class="subtitle">Single-Page UI · Backend-Proxy auf Power Automate</div>
        </div>
      </div>

      <div class="pillbar" aria-label="Statusleiste">
        <div class="pill" title="API-Status (aus /api/health)">
          <span class="dot" id="apiDot"></span>
          <span>API: <span id="apiStatus">unbekannt</span></span>
        </div>
        <div class="pill pill-run" title="Letzter Lauf / Fortschritt">
          <span class="dot" id="runDot"></span>
          <div class="run-meta">
            <div class="run-line">
              <span class="small">Run:</span>
              <span id="runId" class="kbd">-</span>
              <span id="runStage" class="small muted">-</span>
              <span id="runProgressLabel" class="kbd">0%</span>
            </div>
            <div class="run-progress">
              <div id="runProgressBar"></div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="layout">
      <section class="card" aria-labelledby="card-input-title">
        <div class="card-h">
          <div>
            <h2 id="card-input-title">Eingabe / Angebotskontext</h2>
            <p>Strukturiere die Eingangsdaten, damit das Modell einen belastbaren Angebotsentwurf erzeugt.</p>
          </div>
          <div class="small" title="Pflichtfelder zuerst">??</div>
        </div>

        <div class="card-b">
          <div class="grid2">
            <div class="stack-vertical">
              <div class="field">
                <label for="customer" data-tip-key="customer">Kunde / Projekt <span class="tip-icon" tabindex="0" data-tip-key="customer" aria-label="Hinweis zu Kunde / Projekt">i</span></label>
                <input id="customer" type="text" placeholder="z. B. ACME GmbH" />
              </div>

              <div class="field" data-field="responsiblePerson">
                <label for="responsiblePerson">Verantwortliche Person (Kunde)</label>
                <input id="responsiblePerson" type="text" placeholder="z. B. Max Mustermann" required aria-required="true" autocomplete="name" />
                <div id="responsiblePersonError" class="error-text" aria-live="polite"></div>
              </div>

              <div class="field">
                <label for="email" data-tip-key="email">E-Mail <span class="tip-icon" tabindex="0" data-tip-key="email" aria-label="Hinweis zu E-Mail">i</span></label>
                <input id="email" type="email" placeholder="name@bechtle.com" value="max.bechtle@bechtle.com" required aria-required="true" />
                <div id="emailError" class="field-error">
                  Bitte eine gültige Bechtle-E-Mail (@bechtle.com) eingeben.
                </div>
              </div>
            </div>

            <div class="field">
              <label for="categorySelect" data-tip-key="category">Angebotskategorie <span class="tip-icon" tabindex="0" data-tip-key="category" aria-label="Hinweis zu Angebotskategorie">i</span></label>
              <div class="select" id="categorySelectWrapper">
                <button id="categorySelect" class="select-button" type="button" aria-haspopup="listbox" aria-expanded="false">
                  <span id="categoryLabel">Security</span>
                  <span class="select-caret">▾</span>
                </button>
                <div class="select-popover" id="categoryPopover">
                  <ul class="select-options" role="listbox" aria-label="Angebotskategorie" id="categoryOptions"></ul>
                </div>
              </div>
            </div>
          </div>

          <div class="field">
            <label for="primaryGoal" data-tip-key="primaryGoal">Primäres Ziel <span class="tip-icon" tabindex="0" data-tip-key="primaryGoal" aria-label="Hinweis zu Primäres Ziel">i</span></label>
            <input id="primaryGoal" type="text" placeholder="z. B. Absicherung von Cloud-Workloads" />
          </div>

          <div class="field">
            <label for="situation" data-tip-key="situation">Kundensituation <span class="tip-icon" tabindex="0" data-tip-key="situation" aria-label="Hinweis zu Kundensituation">i</span></label>
            <textarea id="situation" placeholder="Aktuelle IT-Landschaft, Herausforderungen, Stakeholder …"></textarea>
          </div>

          <div class="field">
            <label for="scope" data-tip-key="scope">Leistungsumfang (Stichpunkte) <span class="tip-icon" tabindex="0" data-tip-key="scope" aria-label="Hinweis zu Leistungsumfang">i</span></label>
            <textarea id="scope" placeholder="Workshops, Architektur-Review, Umsetzung, Betrieb …"></textarea>
          </div>

          <div class="field">
            <label for="pt">PT (optional)</label>
            <input id="pt" type="number" min="0" step="0.5" placeholder="z. B. 12.5" />
          </div>

          <div class="grid2">
            <div class="field">
              <label for="detailDescription" data-tip-key="detailDescription">Detailbeschreibung (wichtig) <span class="tip-icon" tabindex="0" data-tip-key="detailDescription" aria-label="Hinweis zu Detailbeschreibung">i</span></label>
              <textarea id="detailDescription" placeholder="Tiefe Beschreibung des Szenarios, notwendige Randbedingungen, Sicherheitsvorgaben …"></textarea>
            </div>

            <div class="field">
              <label for="notes" data-tip-key="notes">Weitere Hinweise (optional) <span class="tip-icon" tabindex="0" data-tip-key="notes" aria-label="Hinweis zu Weitere Hinweise">i</span></label>
              <textarea id="notes" placeholder="Organisatorisches, Wünsche, Abgrenzungen …"></textarea>
            </div>
          </div>

          <div class="btnbar">
            <button id="generateBtn" class="btn btn-primary" type="button">
              Angebot generieren
            </button>
            <button id="resetBtn" class="btn btn-ghost" type="button">Zurücksetzen</button>
            <button id="copyRun" class="btn btn-ghost" type="button">Run kopieren</button>
          </div>

          <div class="notice" id="feedbackNotice" role="status" aria-live="polite"></div>
        </div>
      </section>

      <section class="card" aria-labelledby="card-output-title">
        <div class="card-h">
          <div>
            <h2 id="card-output-title">Generiertes Angebot</h2>
            <p>Hier erscheint das generierte Angebot (Text oder JSON). Tabs umschalten, um Details zu sehen.</p>
          </div>
        </div>

        <div class="card-b">
          <div class="tabs" role="tablist">
            <button class="tab-btn active" data-tab="text" role="tab" aria-selected="true">Text</button>
            <button class="tab-btn" data-tab="json" role="tab" aria-selected="false">JSON</button>
          </div>
          <div class="panel" id="panel-text" role="tabpanel" aria-label="Text Panel">Noch kein Angebot generiert.</div>
          <div class="panel mono hidden" id="panel-json" role="tabpanel" aria-label="JSON Panel">{}</div>
          <div class="refs-wrap" id="refsWrap" aria-label="Referenzen">
            <div class="refs-title">Referenzen</div>
            <div id="refsList" class="refs-list small">Keine Referenzen vorhanden.</div>
          </div>
        </div>

        <div class="card-h">
          <div>
            <h2>Feedback</h2>
            <p>Bewerte das Ergebnis (optional).</p>
          </div>
        </div>
        <div class="card-b">
          <div class="radio-row" role="radiogroup" aria-label="Feedback Bewertung">
            <label><input type="radio" name="rating" value="bad" /> Schlecht</label>
            <label><input type="radio" name="rating" value="meh" /> Mittel</label>
            <label><input type="radio" name="rating" value="ok" /> Gut</label>
            <label><input type="radio" name="rating" value="great" /> Super</label>
          </div>
          <textarea id="feedbackText" placeholder="Optionaler Kommentar" style="min-height:80px"></textarea>
          <div class="btnbar">
            <button id="saveFeedback" class="btn btn-primary" type="button">Feedback speichern</button>
          </div>
        </div>

        <div class="card-h">
          <div>
            <h2>Letzte Runs</h2>
            <p>Historie (falls Backend erreichbar).</p>
          </div>
          <button id="refreshHistory" class="btn btn-ghost" type="button">Aktualisieren</button>
        </div>
        <div class="card-b">
          <table>
            <thead>
              <tr>
                <th>Start</th>
                <th>Kunde</th>
                <th>Kategorie</th>
                <th>Rating</th>
                <th>Aktion</th>
              </tr>
            </thead>
            <tbody id="historyBody">
              <tr><td colspan="5" class="small">Keine Historie vorhanden.</td></tr>
            </tbody>
          </table>
        </div>

        <div class="card-h">
          <div>
            <h2>Eval / Scoring</h2>
            <p>Bewerte die Qualität des Angebots (optional).</p>
          </div>
        </div>
        <div class="card-b">
          <div class="eval">
            <div class="radio-row" role="radiogroup" aria-label="Eval Rating">
              <label><input type="radio" name="ratingEval" value="1" /> 1</label>
              <label><input type="radio" name="ratingEval" value="2" /> 2</label>
              <label><input type="radio" name="ratingEval" value="3" /> 3</label>
              <label><input type="radio" name="ratingEval" value="4" /> 4</label>
              <label><input type="radio" name="ratingEval" value="5" /> 5</label>
            </div>
          </div>
        </div>

        <div class="foot">
          Backend ruft Power Automate (HTTP Trigger) über /api/generate-offer auf. Bitte Feld "Verantwortliche Person (Kunde)" ausfüllen.
        </div>
      </section>
    </main>
  </div>

  <script src="./tooltips.js"></script>
  <script src="./config.js"></script>
  <script>
    const CATEGORY_OPTIONS = ["Security", "Modern Workplace", "Cloud", "Data / AI", "Netzwerk", "Sonstiges"];
    let categoryIndex = 0;
    let categoryValue = CATEGORY_OPTIONS[0];

    const panels = {
      text: document.getElementById("panel-text"),
      json: document.getElementById("panel-json"),
    };
    const tabs = document.querySelectorAll(".tab-btn");
    tabs.forEach(btn => {
      btn.addEventListener("click", () => {
        tabs.forEach(el => el.classList.remove("active"));
        btn.classList.add("active");
        const tab = btn.dataset.tab;
        panels.text.classList.toggle("hidden", tab !== "text");
        panels.json.classList.toggle("hidden", tab !== "json");
        btn.setAttribute("aria-selected", "true");
        tabs.forEach(el => { if(el !== btn) el.setAttribute("aria-selected", "false"); });
      });
    });

    const apiStatus = document.getElementById("apiStatus");
    const apiDot = document.getElementById("apiDot");
    const runIdEl = document.getElementById("runId");
    const runStage = document.getElementById("runStage");
    const runDot = document.getElementById("runDot");
    const runProgressBar = document.getElementById("runProgressBar");
    const runProgressLabel = document.getElementById("runProgressLabel");
    const refsWrap = document.getElementById("refsWrap");
    const refsList = document.getElementById("refsList");
    const generateBtn = document.getElementById("generateBtn");
    const feedbackNotice = document.getElementById("feedbackNotice");
    const spinner = document.getElementById("spinner");

    let isLoading = false;
    let lastRun = null;
    let lastContext = null;
    let progressTimer = null;
    let progressStartMs = 0;
    let loadingTimeout = null;

    function $(id){ return document.getElementById(id); }

    function setLoading(flag){
      isLoading = flag;
      generateBtn.disabled = flag;
      if(spinner){ spinner.classList.add("hidden"); }
      if(loadingTimeout){
        clearTimeout(loadingTimeout);
        loadingTimeout = null;
      }
      if(flag){
        loadingTimeout = setTimeout(() => {
          isLoading = false;
          generateBtn.disabled = false;
          if(spinner){ spinner.classList.add("hidden"); }
        }, 180000);
      }
    }

    function nowDE(){
      return new Date().toLocaleString("de-DE");
    }

    function apiUrl(path){
      if(path.startsWith("http")) return path;
      const base = window.API_BASE || "";
      return base + path;
    }

    async function safeFetch(url, options){
      const res = await fetch(url, options);
      const text = await res.text();
      let data = null;
      try{ data = JSON.parse(text); }catch(_){}
      if(!res.ok){
        const msg = (data && (data.error || data.message)) ? String(data.error || data.message) : text || res.statusText || "Request fehlgeschlagen";
        throw new Error(msg);
      }
      return data;
    }

    function formatJsonPanel(data){
      if(typeof data === "string") return data;
      try { return JSON.stringify(data ?? {}, null, 2); } catch (_) { return String(data); }
    }

    function offerJsonToText(anyData, options = {}){
      const includeReferences = options.includeReferences === true;
      function tryParse(val){
        if(typeof val === "string"){
          try { return JSON.parse(val); } catch(_) { return null; }
        }
        return val;
      }

      function isOffer(obj){
        if(!obj || typeof obj !== "object") return false;
        return Array.isArray(obj.leistungsumfang) || typeof obj.kostenuebersicht === "object" || typeof obj.kundendaten === "object";
      }

      function findOffer(obj, depth = 0){
        if(!obj || typeof obj !== "object" || depth > 4) return null;
        if(isOffer(obj)) return obj;
        const keys = ["offer","output","result","data","body","raw","response","payload","value"];
        for(const key of keys){
          if(Object.prototype.hasOwnProperty.call(obj, key)){
            const cand = tryParse(obj[key]);
            const found = isOffer(cand) ? cand : findOffer(cand, depth + 1);
            if(found) return found;
          }
        }
        return null;
      }

      const root = tryParse(anyData);
      const offer = isOffer(root) ? root : findOffer(root);
      if(!offer) return "";

      const lines = [];
      const kd = offer.kundendaten || {};
      const pb = offer.projektbeschreibung || {};
      const lw = Array.isArray(offer.leistungsumfang) ? offer.leistungsumfang : [];
      const kosten = offer.kostenuebersicht || {};
      const refs = Array.isArray(offer.referenzen) ? offer.referenzen : [];
      const opt = offer.optionale_abschnitte || {};

      const fmtMoney = (n) => {
        const num = typeof n === "number" ? n : Number(String(n).replace(/\./g, "").replace(",", "."));
        return Number.isFinite(num) ? new Intl.NumberFormat("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num) : null;
      };

      lines.push(`Angebot${offer.dokument_id ? ` (${offer.dokument_id})` : ""}`);
      const kdParts = [];
      if(kd.firma) kdParts.push(`Kunde: ${kd.firma}`);
      if(kd.kontaktperson) kdParts.push(`Kontakt: ${kd.kontaktperson}`);
      if(kd.branche) kdParts.push(`Branche: ${kd.branche}`);
      if(kd.standort) kdParts.push(`Standort: ${kd.standort}`);
      if(kdParts.length){ lines.push(kdParts.join(" | ")); }
      lines.push("");

      if(pb.ziel || pb.ausgangssituation || pb.umfang){
        lines.push("Projektziel:");
        if(pb.ziel) lines.push(`- ${pb.ziel}`);
        lines.push("Ausgangssituation:");
        if(pb.ausgangssituation) lines.push(`- ${pb.ausgangssituation}`);
        lines.push("Umfang:");
        if(pb.umfang) lines.push(`- ${pb.umfang}`);
        lines.push("");
      }

      if(lw.length){
        lines.push("Leistungsumfang:");
        lw.forEach((pos, idx) => {
          const nr = pos.positionsnummer || idx + 1;
          const meta = [pos.kategorie, pos.bezugsobjekt].filter(Boolean).join(" / ");
          const title = pos.titel ? ` – ${pos.titel}` : "";
          const header = `Pos. ${nr}${title}${meta ? ` (${meta})` : ""}`;
          lines.push(header);
          if(pos.beschreibung) lines.push(String(pos.beschreibung));
          lines.push("");
        });
      }

      const moneyLines = [];
      if(kosten.zwischensumme != null){
        const v = fmtMoney(kosten.zwischensumme);
        if(v) moneyLines.push(`- Zwischensumme: ${v} ${kosten.waehrung || "EUR"}`);
      }
      if(kosten.rabatte != null){
        const v = fmtMoney(kosten.rabatte);
        if(v) moneyLines.push(`- Rabatte: ${v} ${kosten.waehrung || "EUR"}`);
      }
      if(kosten.gesamtbetrag != null){
        const v = fmtMoney(kosten.gesamtbetrag);
        if(v) moneyLines.push(`- Gesamtbetrag: ${v} ${kosten.waehrung || "EUR"}`);
      }
      const posArr = Array.isArray(kosten.positionen) ? kosten.positionen : [];
      if(moneyLines.length || posArr.length){
        lines.push("Kostenübersicht:");
        moneyLines.forEach(l => lines.push(l));
        if(posArr.length){
          lines.push("Positionen:");
          posArr.forEach((p, idx) => {
            const nr = p.positionsnummer || idx + 1;
            const menge = fmtMoney(p.menge) || p.menge;
            const einzel = fmtMoney(p.einzelpreis);
            const gesamt = fmtMoney(p.gesamtpreis);
            const waehrung = p.waehrung || kosten.waehrung || "EUR";
            const unit = [menge, p.einheit].filter(Boolean).join(" ");
            const pricePart = (einzel && unit) ? `${unit} × ${einzel}` : (einzel || unit || "");
            const totalPart = gesamt ? ` = ${gesamt} ${waehrung}` : (waehrung && pricePart ? ` ${waehrung}` : "");
            lines.push(`- Pos. ${nr}${p.titel ? ` – ${p.titel}` : ""}: ${pricePart}${totalPart}`);
          });
        }
        lines.push("");
      }

      if(includeReferences && refs.length){
        lines.push("Referenzen:");
        refs.forEach(r => {
          const cls = [r.primaerklasse, r.sekundaerklasse].filter(Boolean).join(" / ");
          const reason = r.aehnlichkeitsgrund || r.ähnlichkeitsgrund || r.reason || "";
          const id = r.dokument_id || r.id || "?";
          const line = `- ${id}${cls ? ` (${cls})` : ""}${reason ? `: ${reason}` : ""}`;
          lines.push(line);
        });
        lines.push("");
      }

      const optEntries = Object.entries(opt).filter(([_, v]) => Boolean(v));
      if(optEntries.length){
        lines.push("Optionale Abschnitte:");
        optEntries.forEach(([key, val]) => {
          const label = key.replace(/_/g, " ");
          lines.push(`- ${label}: ${val}`);
        });
        lines.push("");
      }

      return lines.join("\n").trim();
    }

    function extractReferences(run){
      const tryParse = (val) => {
        if(typeof val === "string"){
          try{ return JSON.parse(val); }catch(_){ return null; }
        }
        return val;
      };

      const root = typeof run === "string" ? tryParse(run) : run;

      const sources = [
        root?.referenzen,
        root?.references,
        root?.referenzDokumente,
        root?.raw?.referenzen,
        root?.raw?.references,
        root?.raw?.referenzDokumente,
      ];

      let list = [];
      for(const src of sources){
        const parsed = tryParse(src);
        if(Array.isArray(parsed) && parsed.length){
          list = parsed;
          break;
        }
      }

      if(!Array.isArray(list)) return [];

      return list.map((entry) => {
        let ref = entry;
        if(typeof entry === "string"){
          const parsed = tryParse(entry);
          ref = parsed && typeof parsed === "object" ? parsed : { dokument_id: entry };
        }
        const id = ref?.dokument_id || ref?.document_id || ref?.id || ref?.doc_id || "";
        const primary = ref?.primaerklasse || ref?.["primärklasse"] || ref?.primaryClass || ref?.primary_class || "";
        const secondary = ref?.sekundaerklasse || ref?.["sekundärklasse"] || ref?.secondaryClass || ref?.secondary_class || "";
        const reason = ref?.aehnlichkeitsgrund || ref?.["ähnlichkeitsgrund"] || ref?.reason || ref?.begruendung || ref?.match_reason || "";
        return {
          id: id || "-",
          primary,
          secondary,
          reason
        };
      }).filter(r => r.id || r.primary || r.secondary || r.reason);
    }

    function renderReferences(run){
      if(!refsList) return;
      const refs = extractReferences(run);
      refsList.innerHTML = "";

      if(!refs || refs.length === 0){
        refsList.textContent = "Keine Referenzen vorhanden.";
        return;
      }

      refs.forEach(ref => {
        const item = document.createElement("div");
        item.className = "refs-item";

        const head = document.createElement("div");
        head.className = "refs-head";

        const idEl = document.createElement("span");
        idEl.className = "refs-id kbd";
        idEl.textContent = ref.id || "-";

        const tags = document.createElement("span");
        tags.className = "refs-tags";
        if(ref.primary){
          const t = document.createElement("span");
          t.className = "tag";
          t.textContent = ref.primary;
          tags.appendChild(t);
        }
        if(ref.secondary){
          const t = document.createElement("span");
          t.className = "tag tag-ghost";
          t.textContent = ref.secondary;
          tags.appendChild(t);
        }

        head.appendChild(idEl);
        head.appendChild(tags);

        const reasonEl = document.createElement("div");
        reasonEl.className = "refs-reason";
        reasonEl.textContent = ref.reason || "—";

        item.appendChild(head);
        item.appendChild(reasonEl);

        refsList.appendChild(item);
      });
    }

    function renderRun(run){
      lastRun = run;

      runIdEl.textContent = run?.runId || "-";

      const pretty = offerJsonToText(run);
      const text = pretty || (typeof run?.text === "string" ? run.text : "");
      panels.text.textContent = text || "Keine Antwort erhalten.";
      panels.json.textContent = formatJsonPanel(run);
      renderReferences(run);
    }
    function parsePtValue(raw){
      if(!raw) return null;
      const normalized = String(raw).replace(",", ".").trim();
      const num = Number(normalized);
      return Number.isFinite(num) ? num : null;
    }

    function collectFormValues(){
      return {
        companyOrProject: $("customer").value?.trim() || "",
        responsiblePerson: $("responsiblePerson").value?.trim() || "",
        email: $("email").value?.trim() || "",
        contactPerson: "",
        primaryCategory: categoryValue,
        primaryGoal: $("primaryGoal").value?.trim() || "",
        customerSituation: $("situation").value?.trim() || "",
        serviceScope: $("scope").value?.trim() || "",
        pt: parsePtValue($("pt").value),
        details: $("detailDescription").value?.trim() || "",
        additionalNotes: $("notes").value?.trim() || ""
      };
    }

    function buildFlowPayload(values){
      return {
        customer: {
          companyOrProject: values.companyOrProject,
          responsiblePerson: values.responsiblePerson,
          contactPerson: values.email || ""
        },
        offer: { primaryCategory: values.primaryCategory },
        goals: { primary: values.primaryGoal, secondary: "" },
        context: {
          customerSituation: values.customerSituation,
          serviceScope: values.serviceScope,
          pt: values.pt,
          details: values.details,
          additionalNotes: values.additionalNotes
        }
      };
    }

    function buildFlowPayloadFromUi(){
      const values = collectFormValues();
      const payload = buildFlowPayload(values);
      return {
        ...payload,
        meta: { source: "web", ts: new Date().toISOString() }
      };
    }

    function clearFieldError(key){
      const wrapper = document.querySelector(`[data-field="${key}"]`);
      if(wrapper){ wrapper.classList.remove("error"); }
      const msg = document.getElementById(`${key}Error`);
      if(msg){ msg.textContent = ""; msg.classList.remove("show"); }
    }

    function showFieldError(key, message){
      const wrapper = document.querySelector(`[data-field="${key}"]`);
      if(wrapper){ wrapper.classList.add("error"); }
      const msg = document.getElementById(`${key}Error`);
      if(msg){ msg.textContent = message; msg.classList.add("show"); }
    }

    function validateEmail(){
      const val = $("email").value?.trim() || "";
      const errEl = $("emailError");
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const ok = Boolean(val) && emailRegex.test(val) && val.toLowerCase().endsWith("@bechtle.com");
      if(ok){
        errEl.style.display = "none";
      }else{
        errEl.style.display = "block";
      }
      if(!isLoading){ generateBtn.disabled = !ok; }
      return ok;
    }

    function validateForm(values){
      clearFieldError("responsiblePerson");
      let ok = true;
      if(!values.responsiblePerson){
        showFieldError("responsiblePerson", "Bitte Verantwortliche Person angeben.");
        ok = false;
      }
      if(!validateEmail()){ ok = false; }
      return ok;
    }

    function setApiStatus(text, tone){
      apiStatus.textContent = text;
      apiDot.classList.remove("ok", "warn", "bad");
      if(tone === "ok") apiDot.classList.add("ok");
      if(tone === "warn") apiDot.classList.add("warn");
      if(tone === "bad") apiDot.classList.add("bad");
    }

    function setRunTone(tone){
      runDot.classList.remove("ok", "warn", "bad");
      if(tone === "ok") runDot.classList.add("ok");
      if(tone === "warn") runDot.classList.add("warn");
      if(tone === "bad") runDot.classList.add("bad");
    }

    function setRunProgress(pct, stageText){
      const p = Math.max(0, Math.min(100, Math.round(pct)));
      runProgressBar.style.width = p + "%";
      runProgressLabel.textContent = p + "%";
      if(stageText) runStage.textContent = stageText;
    }

    function stopFakeRunProgress(){
      if(progressTimer){
        clearInterval(progressTimer);
        progressTimer = null;
      }
    }

    function startFakeRunProgress(){
      stopFakeRunProgress();
      progressStartMs = Date.now();
      const rampTo70Ms = 120000; // 2 Minuten
      const ramp70to100Ms = 60000; // 1 Minute
      const totalMs = rampTo70Ms + ramp70to100Ms;

      setRunProgress(0, "Angebot wird generiert...");

      progressTimer = setInterval(() => {
        const t = Date.now() - progressStartMs;
        if (t <= rampTo70Ms){
          const pct = (t / rampTo70Ms) * 70;
          setRunProgress(pct, "Angebot wird generiert...");
          return;
        }

        const t2 = Math.min(ramp70to100Ms, t - rampTo70Ms);
        const pct = 70 + (t2 / ramp70to100Ms) * 30;
        setRunProgress(pct, "Angebot wird zum Versenden vorbereitet...");

        if (t >= totalMs){
          stopFakeRunProgress();
          setRunProgress(100, "Angebot wird zum Versenden vorbereitet...");
          setLoading(false);
        }
      }, 500);
    }

    async function checkHealth(){
      try{
        const data = await safeFetch(apiUrl("/api/health"), { method: "GET" });
        const apiText = data?.api || "online";
        const tone = apiText.toLowerCase().includes("offline") ? "warn" : "ok";
        setApiStatus(apiText, tone);
        if(runIdEl.textContent === "-" && data?.run){
          runIdEl.textContent = data.run;
        }
      }catch(e){
        setApiStatus("offline (Demo-Modus)", "warn");
      }
    }

    generateBtn.addEventListener("click", async () => {
      const formValues = collectFormValues();

      if(!validateForm(formValues)){
        panels.text.textContent = "Bitte Verantwortliche Person angeben.";
        return;
      }

      if(!validateEmail()){
        panels.text.textContent = "Bitte E-Mail prüfen (nur @bechtle.com).";
        panels.json.textContent = JSON.stringify({ status:"invalid_input", field:"email" }, null, 2);
        setApiStatus("Eingabe prüfen", "warn");
        return;
      }

      if(!formValues.primaryGoal && !formValues.customerSituation && !formValues.details){
        panels.text.textContent = "Bitte mindestens \"Primäres Ziel\", \"Kundensituation\" oder \"Detailbeschreibung\" ausfüllen.";
        return;
      }

      setLoading(true);
      feedbackNotice.classList.remove("show");
      setApiStatus("läuft", "warn");
      setRunTone("warn");
      setRunProgress(0, "Angebot wird generiert...");
      runIdEl.textContent = "local-" + Math.random().toString(16).slice(2, 8);
      panels.text.textContent = "Bitte warten – Angebot wird generiert …";
      panels.json.textContent = JSON.stringify({ status: "pending", startedAt: new Date().toISOString() }, null, 2);
      if(refsList){
        refsList.textContent = "Bitte warten – Referenzen werden geladen …";
      }
      startFakeRunProgress();

      const payload = buildFlowPayloadFromUi();
      lastContext = payload;

      try{
        const run = await safeFetch(apiUrl("/api/generate-offer"), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        stopFakeRunProgress();
        setRunTone("ok");
        setRunProgress(100, "Antwort empfangen");
        renderRun(run);
        setApiStatus("fertig", "ok");
        checkHealth();
      }catch(err){
        stopFakeRunProgress();
        setRunTone("bad");
        setRunProgress(100, "Fehler");
        const errorText = String(err?.message || err);
        const errorObj = {
          status: "failed",
          error: errorText,
          request: payload,
          receivedAt: new Date().toISOString()
        };
        panels.text.textContent = "Request fehlgeschlagen: " + errorText;
        panels.json.textContent = formatJsonPanel(errorObj);
        if(refsList){
          refsList.textContent = "Keine Referenzen (Request fehlgeschlagen).";
        }
      } finally {
        setLoading(false);
      }
    });

    $("responsiblePerson").addEventListener("input", () => clearFieldError("responsiblePerson"));
    $("email").addEventListener("input", () => {
      validateEmail();
      if(!validateEmail()){
        setApiStatus("Eingabe prüfen", "warn");
      }
    });

    $("resetBtn").addEventListener("click", () => {
      ["customer","responsiblePerson","primaryGoal","situation","scope","pt","detailDescription","notes","feedbackText"].forEach(id => $(id).value = "");
      $("email").value = "max.bechtle@bechtle.com";
      document.querySelectorAll('input[name="rating"]').forEach(r => r.checked = false);
      clearFieldError("responsiblePerson");
      panels.text.textContent = "Noch kein Angebot generiert.";
      panels.json.textContent = "{}";
      runIdEl.textContent = "-";
      feedbackNotice.classList.remove("show");
      lastRun = null;
      lastContext = null;
      stopFakeRunProgress();
      setRunTone(null);
      setRunProgress(0, "-");
      if(refsList){
        refsList.textContent = "Keine Referenzen vorhanden.";
      }
    });

    $("saveFeedback").addEventListener("click", async () => {
      const rating = document.querySelector('input[name="rating"]:checked')?.value || null;
      const comment = $("feedbackText").value?.trim() || "";

      const payload = {
        runId: lastRun?.runId || null,
        rating,
        comment,
        context: lastRun?.request || lastRun?.context || lastContext || buildFlowPayloadFromUi(),
        clientTime: new Date().toISOString()
      };

      try{
        await safeFetch(apiUrl("/api/feedback"), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        feedbackNotice.textContent = "Feedback gespeichert - danke!";
      }catch(e){
        feedbackNotice.textContent = "Feedback lokal gespeichert (Backend nicht erreichbar).";
        try{
          const key = "presales_feedback_" + (payload.runId || "noid");
          localStorage.setItem(key, JSON.stringify(payload));
        }catch(_){}
      }
      feedbackNotice.classList.add("show");
      setTimeout(() => feedbackNotice.classList.remove("show"), 2200);
    });

    $("copyRun").addEventListener("click", async () => {
      if(!lastRun){ return; }
      const text = JSON.stringify(lastRun, null, 2);
      try{
        await navigator.clipboard.writeText(text);
        feedbackNotice.textContent = "Run (JSON) kopiert.";
        feedbackNotice.classList.add("show");
        setTimeout(() => feedbackNotice.classList.remove("show"), 1500);
      }catch(e){
        feedbackNotice.textContent = "Kopieren nicht möglich (Browser-Policy).";
        feedbackNotice.classList.add("show");
        setTimeout(() => feedbackNotice.classList.remove("show"), 1500);
      }
    });

    async function loadHistory(){
      const body = $("historyBody");
      body.innerHTML = `<tr><td colspan="5" class="small">Lade Historie …</td></tr>`;
      try{
        const data = await safeFetch(apiUrl("/api/history"), { method: "GET" });
        const items = data?.items || [];
        if(!Array.isArray(items) || items.length === 0){
          body.innerHTML = `<tr><td colspan="5" class="small">Keine Historie vorhanden.</td></tr>`;
          return;
        }

        body.innerHTML = "";
        items.slice(0, 20).forEach(item => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${item.startedAt ? new Date(item.startedAt).toLocaleString("de-DE") : "-"}</td>
            <td>${item.customer || "-"}</td>
            <td><span class="tag">${item.category || "-"}</span></td>
            <td class="rating">${toRatingEmoji(item.rating)}</td>
            <td><button class="btn btn-ghost" type="button" data-open="${item.runId || ""}">Öffnen</button></td>
          `;
          body.appendChild(tr);
        });

        body.querySelectorAll("button[data-open]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-open");
            if(!id) return;
            try{
              const run = await safeFetch(apiUrl(`/api/run/${encodeURIComponent(id)}`), { method: "GET" });
              renderRun(run);
              document.querySelector('.tab-btn[data-tab="text"]').click();
            }catch(e){
              panels.text.textContent = "Run konnte nicht geladen werden: " + String(e.message || e);
            }
          });
        });

      }catch(e){
        body.innerHTML = `<tr><td colspan="5" class="small">Historie nicht erreichbar (Backend fehlt). Demo-Einträge werden angezeigt.</td></tr>`;
        const demo = [
          { startedAt: nowDE(), customer: "Demo Kunde", category: "Security", rating: "ok", runId: "demo-001" }
        ];
        demo.forEach(item => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${item.startedAt}</td>
            <td>${item.customer}</td>
            <td><span class="tag">${item.category}</span></td>
            <td class="rating">${toRatingEmoji(item.rating)}</td>
            <td><button class="btn btn-ghost" type="button" disabled>Öffnen</button></td>
          `;
          body.appendChild(tr);
        });
      }
    }

    $("refreshHistory").addEventListener("click", loadHistory);

    // ---------------------------
    // Custom select (Kategorie)
    // ---------------------------
    (function setupCategorySelect(){
      const btn = $("categorySelect");
      const label = $("categoryLabel");
      const popover = $("categoryPopover");
      const list = $("categoryOptions");

      function renderOptions(){
        list.innerHTML = "";
        CATEGORY_OPTIONS.forEach((opt, idx) => {
          const li = document.createElement("li");
          li.className = "select-option" + (idx === categoryIndex ? " active" : "");
          li.setAttribute("role", "option");
          li.setAttribute("tabindex", "-1");
          li.setAttribute("aria-selected", idx === categoryIndex ? "true" : "false");
          li.dataset.value = opt;
          li.dataset.index = String(idx);
          li.textContent = opt;
          li.addEventListener("click", () => selectValue(idx));
          li.addEventListener("mouseenter", () => highlight(idx));
          list.appendChild(li);
        });
      }

      function selectValue(idx){
        categoryIndex = idx;
        categoryValue = CATEGORY_OPTIONS[idx];
        label.textContent = categoryValue;
        renderOptions();
        close();
        btn.focus();
      }

      function highlight(idx){
        const items = list.querySelectorAll(".select-option");
        items.forEach((el, i) => {
          el.classList.toggle("active", i === idx);
          el.setAttribute("aria-selected", i === idx ? "true" : "false");
        });
      }

      function open(){
        popover.classList.add("open");
        btn.setAttribute("aria-expanded", "true");
        highlight(categoryIndex);
        const active = list.querySelector(".select-option.active");
        if(active) active.focus();
        document.addEventListener("mousedown", onOutside);
      }
      function close(){
        popover.classList.remove("open");
        btn.setAttribute("aria-expanded", "false");
        document.removeEventListener("mousedown", onOutside);
      }
      function toggle(){ popover.classList.contains("open") ? close() : open(); }

      function onOutside(e){
        if(!popover.contains(e.target) && !btn.contains(e.target)){
          close();
        }
      }

      function onKeyDown(e){
        const isOpen = popover.classList.contains("open");
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          toggle();
        } else if(e.key === "ArrowDown"){
          e.preventDefault();
          if(!isOpen){ open(); return; }
          categoryIndex = (categoryIndex + 1) % CATEGORY_OPTIONS.length;
          highlight(categoryIndex);
          focusActive();
        } else if(e.key === "ArrowUp"){
          e.preventDefault();
          if(!isOpen){ open(); return; }
          categoryIndex = (categoryIndex - 1 + CATEGORY_OPTIONS.length) % CATEGORY_OPTIONS.length;
          highlight(categoryIndex);
          focusActive();
        } else if(e.key === "Escape"){
          if(isOpen){
            e.preventDefault();
            close();
            btn.focus();
          }
        }
      }

      function focusActive(){
        const active = list.querySelector(".select-option.active");
        if(active) active.focus();
      }

      btn.addEventListener("click", toggle);
      btn.addEventListener("keydown", onKeyDown);
      list.addEventListener("keydown", (e) => {
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          const idx = Number(document.activeElement.dataset.index || categoryIndex);
          selectValue(idx);
        } else if(e.key === "ArrowDown" || e.key === "ArrowUp" || e.key === "Escape"){
          onKeyDown(e);
        }
      });
      list.addEventListener("focusout", (e) => {
        if(!popover.contains(e.relatedTarget) && e.relatedTarget !== btn){
          close();
        }
      });

      renderOptions();
      label.textContent = categoryValue;
    })();

    // ---------------------------
    // Tooltips
    // ---------------------------
    (function setupTooltips(){
      const data = window.TOOLTIPS || {};
      const bubble = document.createElement("div");
      bubble.id = "app-tooltip";
      bubble.className = "tooltip-bubble";
      document.body.appendChild(bubble);

      let showTimer = null;
      let hideTimer = null;
      let currentTarget = null;

      function renderContent(entry){
        const bullets = Array.isArray(entry.bullets) && entry.bullets.length
          ? `<ul>${entry.bullets.map(b => `<li>${b}</li>`).join("")}</ul>`
          : "";
        bubble.innerHTML = `<div class="tooltip-text">${entry.text || ""}</div>${bullets}`;
      }

      function positionBubble(target){
        const rect = target.getBoundingClientRect();
        const top = rect.top + window.scrollY + rect.height + 8;
        const left = rect.left + window.scrollX;
        bubble.style.top = `${top}px`;
        bubble.style.left = `${left}px`;
      }

      function show(target){
        const key = target.dataset.tipKey;
        const entry = key ? data[key] : null;
        if(!entry) return;
        if(hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
        if(showTimer) clearTimeout(showTimer);
        showTimer = setTimeout(() => {
          renderContent(entry);
          positionBubble(target);
          bubble.classList.add("show");
          target.setAttribute("aria-describedby", "app-tooltip");
          currentTarget = target;
        }, 150);
      }

      function hide(){
        if(showTimer){ clearTimeout(showTimer); showTimer = null; }
        if(hideTimer) clearTimeout(hideTimer);
        hideTimer = setTimeout(() => {
          bubble.classList.remove("show");
          bubble.style.top = "-9999px";
          bubble.style.left = "-9999px";
          if(currentTarget){
            currentTarget.removeAttribute("aria-describedby");
            currentTarget = null;
          }
        }, 100);
      }

      document.querySelectorAll("[data-tip-key]").forEach(el => {
        el.addEventListener("mouseenter", () => show(el));
        el.addEventListener("focus", () => show(el));
        el.addEventListener("mouseleave", hide);
        el.addEventListener("blur", hide);
      });

      document.addEventListener("keydown", (e) => {
        if(e.key === "Escape"){
          hide();
        }
      });
    })();

    checkHealth();
    loadHistory();
  </script>
</body>
</html>
